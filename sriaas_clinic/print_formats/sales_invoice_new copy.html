{# ================= Sales Invoice New (SRIAAS Clinic) ================= #}

{# --- self-contained address renderer (no external includes) --- #}
{% macro render_addr(address_name) -%}
  {% if address_name %}
    {% set a = frappe.get_doc("Address", address_name) %}
    <div class="addr">
      {% if a.address_title %}<b>{{ a.address_title }}</b>{% endif %}
      {% if a.address_type %}{% if a.address_title %} {% endif %}({{ a.address_type }}){% endif %}
      {% if a.address_title or a.address_type %}<br>{% endif %}

      {{ a.address_line1 or "" }}
      {% if a.address_line2 %}<br>{{ a.address_line2 }}{% endif %}

      {% if a.city %}<br>{{ a.city }}{% endif %}
      {% if a.state %}{% if a.city %}, {% else %}<br>{% endif %}{{ a.state }}{% endif %}
      {% if a.pincode %} {{ a.pincode }}{% endif %}

      {% if a.country %}<br>{{ a.country }}{% endif %}

      {% set gstin = a.gstin or a.gstin_uin %}
      {% if gstin %}<br><b>GSTIN:</b> {{ gstin }}{% endif %}
    </div>
  {% endif %}
{%- endmacro %}

{# ========== COMPANY + TAX INVOICE HEADER (SRIAAS) ========== #}
{% set company = frappe.get_doc("Company", doc.company) %}
{% set logo = company.company_logo %}
{% set currency = doc.currency or company.default_currency or "INR" %}

{# Prefer the address linked on the invoice; else first Company address #}
{% set comp_addr_name = doc.company_address %}
{% if not comp_addr_name %}
  {% set comp_addr_link = frappe.get_all(
      "Dynamic Link",
      filters={"parenttype":"Address","link_doctype":"Company","link_name":doc.company},
      fields=["parent"], limit=1
  ) %}
  {% set comp_addr_name = comp_addr_link[0].parent if comp_addr_link else None %}
{% endif %}
{% set comp_addr = frappe.get_doc("Address", comp_addr_name) if comp_addr_name else None %}

{# helpers #}
{% macro line(v) -%}{% if v %}{{ v }}<br>{% endif %}{%- endmacro %}
{% set reg_add_1   = (comp_addr.address_line1 if comp_addr else "") %}
{% set reg_add_2   = (comp_addr.address_line2 if comp_addr else "") %}
{% set reg_city    = (comp_addr.city if comp_addr else "") %}
{% set reg_state   = (comp_addr.state if comp_addr else "") %}
{% set reg_pin     = (comp_addr.pincode if comp_addr else "") %}
{% set gst_state_code = (comp_addr.gst_state_number if comp_addr and comp_addr.gst_state_number else "") %}
{% set company_email = company.email_id or company.company_email or "" %}
{% set company_cin   = company.cin or company.company_cin or company.custom_cin or "" %}
{% set company_gstin = doc.company_gstin or (comp_addr.gstin if comp_addr and comp_addr.gstin else "") %}

{# ==== overall GST rate (fixed at 5% if not in taxes) ==== #}
{% set overall_gst_pct = (doc.taxes[0].rate if doc.taxes and doc.taxes[0].rate is not none else 5) %}

<style>
  .si-head{border:1px solid #cfd6e4;border-collapse:collapse;width:100%;font-family:Arial,sans-serif;margin-bottom:10px}
  .si-head td{vertical-align:top;padding:10px}
  .si-head .left{width:65%}
  .si-head .right{width:35%;border-left:1px solid #cfd6e4}
  .si-logo{max-height:40px;margin-bottom:6px}
  .si-co-name{font-weight:700}
  .si-right-title{text-align:right;font-weight:700;padding-bottom:6px}
  .si-meta{width:100%;font-size:12px;border-collapse:collapse}
  .si-meta td{padding:4px 0}
  .si-meta .lbl{color:#555;width:40%;text-align:right;padding-right:10px}
  .si-meta .val{width:60%;text-align:right}
  .si-left-lines{font-size:12px;line-height:1.5}

  .si-wrap{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#111;font-size:10pt}
  .card{width:100%;border:1.25pt solid #cfd6e4;border-collapse:collapse;table-layout:fixed;font-size:10pt;margin-bottom:10pt}
  .kv td{padding:4px 6px;border-bottom:1px solid #e8ebf0;vertical-align:top}
  .kv tr:last-child td{border-bottom:0}
  .lbl{width:120px;color:#444;background:#fafbfc}
  .stack .title{font-weight:600;color:#444;background:#fafbfc;padding:6px}
  .stack .value{padding:6px}
  .tbl{width:100%;border-collapse:collapse;font-size:10pt}
  .tbl th,.tbl td{border:1px solid #e8ebf0;padding:6px;vertical-align:top}
  .right{text-align:right}
  .muted{color:#666}
  .addr{line-height:1.4}
</style>

<table class="si-head">
  <tr>
    <td class="left">
      {% if logo %}<img class="si-logo" src="{{ logo }}">{% endif %}
      <div class="si-co-name">Sr Institute of Advanced Ayurvedic Sciences Private Limited</div>
      <div class="si-left-lines">
        {{ line("Reg Add: " ~ (reg_add_1 or "")) }}
        {{ line(reg_add_2) }}
        {{ line([reg_city, reg_state, reg_pin]|reject("equalto","")|join(", ")) }}
        {{ line("CIN No: " ~ company_cin) }}
        {{ line("GSTIN/UIN: " ~ company_gstin) }}
        {% if reg_state %}{{ line("State Name: " ~ reg_state ~ (", Code: " ~ gst_state_code if gst_state_code else "")) }}{% endif %}
        {{ line("E-mail: " ~ company_email) }}
      </div>
    </td>
    <td class="right">
      <div class="si-right-title">Tax Invoice</div>
      <table class="si-meta">
        <tr><td class="lbl">Invoice No.</td><td class="val">{{ doc.name }}</td></tr>
        <tr><td class="lbl">Invoice Date</td><td class="val">{{ frappe.format(doc.posting_date, {"fieldtype":"Date"}) }}</td></tr>
        <tr><td class="lbl">Due Date</td><td class="val">{% if doc.due_date %}{{ frappe.format(doc.due_date, {"fieldtype":"Date"}) }}{% endif %}</td></tr>
      </table>
    </td>
  </tr>
</table>
{# ========== /HEADER ========== #}

{# ==== customer contact + place of supply ==== #}
{% set cust = frappe.get_doc("Customer", doc.customer) if doc.customer else None %}
{% set cust_mobile = doc.contact_mobile or (cust.mobile_no if cust and cust.mobile_no else "") %}
{% set cust_phone  = doc.contact_phone  or (cust.phone     if cust and cust.phone     else "") %}
{% set cust_email  = doc.contact_email  or (cust.email_id  if cust and cust.email_id  else "") %}

{% set pos_name = doc.place_of_supply or doc.billing_address_gst_state %}
{% set pos_code = doc.billing_address_gst_state_number %}
{% if not pos_name and doc.customer_address %}
  {% set addr_po = frappe.get_doc("Address", doc.customer_address) %}
  {% set pos_name = addr_po.state if addr_po and addr_po.state else pos_name %}
  {% set pos_code = addr_po.gst_state_number if addr_po and addr_po.gst_state_number else pos_code %}
{% endif %}

<div class="si-wrap">

  <table class="card kv">
    <tr>
        <td class="lbl">Customer</td>
        <td>{{ doc.customer_name or doc.customer }}</td>
        <td class="lbl">Place of Supply</td>
        <td>
        {% if pos_name %}{{ pos_name }}{% if pos_code %} (Code: {{ pos_code }}){% endif %}{% else %}-{% endif %}
        </td>
    </tr>
    <tr>
        <td class="lbl">Billing Address</td>
        <td>{{ render_addr(doc.customer_address) }}</td>
        <td class="lbl">Shipping Address</td>
        <td>{{ render_addr(doc.shipping_address_name) }}</td>
    </tr>
    <tr>
        <td class="lbl">Mobile</td>
        <td>{{ cust_mobile or "-" }}</td>
        <td class="lbl">Phone</td>
        <td>{{ cust_phone or "-" }}</td>
    </tr>
    <tr>
        <td class="lbl">Email</td>
        <td colspan="3">{{ cust_email or "-" }}</td>
    </tr>
  </table>

  {# ===== Items ===== #}
  <table class="tbl">
    <thead>
      <tr style="background:#fafbfc;">
        <th style="width:36px;">#</th>
        <th>Item</th>
        <th style="width:90px;">HSN/SAC</th>
        <th style="width:60px;" class="right">GST %</th>
        <th style="width:80px;" class="right">Qty</th>
        <th style="width:90px;" class="right">Rate</th>
        <th style="width:100px;" class="right">Amount</th>
      </tr>
    </thead>
    <tbody>
      {% for it in (doc.items or []) %}
      {% set name = it.item_name or it.item_code %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>
          <div><b>{{ name }}</b>{% if it.uom %} <span class="muted">({{ it.uom }})</span>{% endif %}</div>
          {% if it.description %}<div class="muted">{{ it.description }}</div>{% endif %}
        </td>
        <td>{{ it.gst_hsn_code or it.sac or "" }}</td>
        <td class="right">{{ "{0:.1f}%".format((overall_gst_pct or 0)|float) }}</td>
        <td class="right">{{ frappe.utils.fmt_money(it.qty or 0, 0) }}</td>
        <td class="right">{{ frappe.utils.fmt_money(it.rate or 0, currency=currency) }}</td>
        <td class="right">{{ frappe.utils.fmt_money(it.amount or 0, currency=currency) }}</td>
      </tr>
      {% endfor %}
      {% if not doc.items or doc.items|length == 0 %}
      <tr><td colspan="7" class="muted">No items</td></tr>
      {% endif %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="6" class="right"><b>Subtotal</b></td>
        <td class="right">{{ frappe.utils.fmt_money(doc.total or 0, currency=currency) }}</td>
      </tr>
    </tfoot>
  </table>

  {# ===== Taxes & Totals ===== #}
  {% if doc.taxes and doc.taxes|length %}
  <table class="tbl" style="margin-top:8px;">
    <thead><tr style="background:#fafbfc;"><th>Tax / Charge</th><th style="width:120px;" class="right">Amount</th></tr></thead>
    <tbody>
      {% for tx in doc.taxes %}
      <tr><td>{{ tx.description }}</td><td class="right">{{ frappe.utils.fmt_money(tx.tax_amount or 0, currency=currency) }}</td></tr>
      {% endfor %}
      <tr><td class="right"><b>Grand Total</b></td><td class="right"><b>{{ frappe.utils.fmt_money(doc.grand_total or 0, currency=currency) }}</b></td></tr>
      {% if doc.rounded_total %}<tr><td class="right">Rounded Total</td><td class="right">{{ frappe.utils.fmt_money(doc.rounded_total, currency=currency) }}</td></tr>{% endif %}
      <tr><td class="right">Paid</td><td class="right">{{ frappe.utils.fmt_money(doc.paid_amount or 0, currency=currency) }}</td></tr>
      <tr><td class="right"><b>Outstanding</b></td><td class="right"><b>{{ frappe.utils.fmt_money(doc.outstanding_amount or 0, currency=currency) }}</b></td></tr>
    </tbody>
  </table>
  {% else %}
  <table class="tbl" style="margin-top:8px;">
    <tr><td class="right"><b>Grand Total</b></td><td class="right" style="width:120px;"><b>{{ frappe.utils.fmt_money(doc.grand_total or 0, currency=currency) }}</b></td></tr>
    {% if doc.rounded_total %}<tr><td class="right">Rounded Total</td><td class="right">{{ frappe.utils.fmt_money(doc.rounded_total, currency=currency) }}</td></tr>{% endif %}
    <tr><td class="right">Paid</td><td class="right">{{ frappe.utils.fmt_money(doc.paid_amount or 0, currency=currency) }}</td></tr>
    <tr><td class="right"><b>Outstanding</b></td><td class="right"><b>{{ frappe.utils.fmt_money(doc.outstanding_amount or 0, currency=currency) }}</b></td></tr>
  </table>
  {% endif %}

  {# Amount in words #}
  {% set amt_words = frappe.utils.money_in_words(doc.rounded_total if doc.rounded_total else doc.grand_total, currency) %}
  <div class="stack value" style="margin-top:8px;">
    <b>Amount in Words:</b> {{ amt_words }}
  </div>

  {% if doc.remarks %}
  <div style="margin-top:10px;">
    <div class="stack title">Notes</div>
    <div class="stack value">{{ doc.remarks }}</div>
  </div>
  {% endif %}
</div>
