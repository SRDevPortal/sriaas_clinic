<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Purchase Order - {{ doc.name }}</title>
  <style>
    /* Basic reset */
    body { font-family: "Helvetica Neue", Arial, sans-serif; color: #222; margin: 28px; }
    .container { width: 100%; }
    header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 18px; }
    .company { font-size: 18px; font-weight:700; }
    .title { font-size: 26px; font-weight: 700; margin-top: 8px; }
    .meta { text-align:right; font-size:13px; }
    .addresses { display:flex; gap:20px; margin-bottom: 18px; }
    .box { border: 1px solid #e6e6e6; padding: 12px; border-radius: 4px; font-size:13px; }
    .box h4 { margin: 0 0 6px 0; font-size:14px; }
    table.items { width: 100%; border-collapse: collapse; margin-top: 12px; }
    table.items th, table.items td { border: 1px solid #ddd; padding: 10px; vertical-align: top; font-size:13px; }
    table.items th { background:#fafafa; text-align:left; font-weight:700; }
    table.items td.right { text-align:right; }
    tfoot td { padding:8px 10px; font-size:13px; }
    .small { font-size:12px; color:#666; }
    .footer { margin-top: 22px; border-top:1px solid #eee; padding-top:12px; font-size:12px; color:#444; display:flex; justify-content:space-between; }
    .terms { width:60%; }
    .signature { text-align:right; width:36%; }
    .company-footer { text-align:center; margin-top:20px; font-size:12px; color:#444; }
    /* responsive */
    @media print {
      body { margin: 0; }
    }
  </style>
</head>
<body>
  <div class="container">

    {# Company header #}
    {% set company = frappe.get_doc('Company', doc.company) %}
    <header>
      <div>
        {% if company and company.logo %}
          <img src="{{ company.get_logo() }}" alt="logo" style="height:64px;">
        {% endif %}
        <div class="company">{{ company.company_name or doc.company }}</div>
        {% set comp_addr = "" %}
        {% if company and company.default_address %}
            {% set comp_addr = frappe.get_doc("Address", company.default_address).display or "" %}
        {% endif %}
        <div class="small">{{ comp_addr }}</div>
      </div>

      <div class="meta">
        <div class="title">Purchase Order</div>
        <div style="margin-top:6px;">{{ doc.name }}</div>
        <div class="small">Date: {{ doc.transaction_date or doc.posting_date or nowdate() }}</div>
        <div class="small">Required By: {{ doc.expected_delivery_date or doc.delivery_date or "" }}</div>
      </div>
    </header>

    {# Supplier / Billing / Shipping boxes #}
    <div class="addresses">
      <div style="flex:1;">
        <div class="box">
          <h4>Supplier</h4>
          <div><strong>{{ doc.supplier_name or doc.supplier }}</strong></div>
          {% if doc.supplier_address %}
            <div class="small">{{ (doc.supplier_address or "").replace("\n", "<br>") | safe }}</div>
          {% else %}
            {% set sup = frappe.get_doc('Supplier', doc.supplier) if doc.supplier else None %}
            {% if sup %}
              <div class="small">{{ sup.address_display or sup.get_formatted_address() }}</div>
            {% endif %}
          {% endif %}
          {% if doc.supplier_gstin %}<div class="small">GSTIN: {{ doc.supplier_gstin }}</div>{% elif sup and sup.gstin %}<div class="small">GSTIN: {{ sup.gstin }}</div>{% endif %}
          {% if doc.contact_display %}<div class="small">Contact: {{ doc.contact_display }}</div>{% endif %}
        </div>
      </div>

      <div style="flex:1;">
        <div class="box">
          <h4>Billing Address</h4>
          {% set bill = frappe.get_doc('Address', doc.company_address) if doc.company_address else company %}
          <div class="small">{{ company.address_display or (bill and bill.address_line1) or '' }}</div>
          {% if company and company.gstin %}<div class="small">GSTIN: {{ company.gstin }}</div>{% endif %}
        </div>
      </div>
    </div>

    {# Items table #}
    <table class="items" aria-describedby="items">
      <thead>
        <tr>
          <th style="width:6%;">#</th>
          <th style="width:16%;">Item Code</th>
          <th style="width:34%;">Description</th>
          <th style="width:14%;">Expected Delivery</th>
          <th style="width:10%;">Unit</th>
          <th style="width:10%;">Quantity</th>
        </tr>
      </thead>
      <tbody>
        {% for i, row in enumerate(doc.items or []) %}
        <tr>
          <td>{{ i + 1 }}</td>
          <td>{{ row.item_code or row.item_name }}</td>
          <td>
            <div><strong>{{ row.item_name }}</strong></div>
            {% if row.description %}<div class="small">{{ row.description }}</div>{% endif %}
          </td>
          <td>{{ row.schedule_date or row.expected_delivery_date or "" }}</td>
          <td>{{ row.uom or row.stock_uom or row.uom or "-" }}</td>
          <td class="right">{{ row.qty | int }}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="5" style="text-align:right; font-weight:700;">Total Quantity</td>
          <td class="right">
            {{ (doc.items | map(attribute='qty') | sum) if doc.items else 0 }}
          </td>
        </tr>
      </tfoot>
    </table>

    {# Pricing / Taxes / In words (if present) #}
    <div style="display:flex; gap: 18px; margin-top: 12px;">
      <div style="flex:1;" class="box">
        <h4>Supplier Address Details</h4>
        {% if doc.supplier_address %}
          <div class="small">{{ (doc.supplier_address or "").replace("\n", "<br>") | safe }}</div>
        {% else %}
          {% if sup %}
            <div class="small">{{ sup.get_formatted_address() }}</div>
            {% if sup.gstin %}<div class="small">GSTIN: {{ sup.gstin }}</div>{% endif %}
            {% if sup.contact_person %}<div class="small">Contact: {{ sup.contact_person }}</div>{% endif %}
          {% endif %}
        {% endif %}
      </div>

      <div style="width:320px;">
        <div class="box">
          <h4>Totals</h4>
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <tr>
              <td style="padding:6px 0;">Sub Total</td>
              <td style="text-align:right; padding:6px 0;">{{ doc.rounded_total or doc.grand_total or 0 }}</td>
            </tr>
            <tr>
              <td style="padding:6px 0;">Taxes</td>
              <td style="text-align:right; padding:6px 0;">{{ doc.taxes_and_charges or '' }}</td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:700;">Net Total</td>
              <td style="text-align:right; padding:6px 0; font-weight:700;">{{ doc.net_total or doc.grand_total or 0 }}</td>
            </tr>
            {% if doc.in_words %}
            <tr>
              <td colspan="2" style="padding-top:8px; font-size:12px;">In Words:<br><em>{{ doc.in_words }}</em></td>
            </tr>
            {% endif %}
          </table>
        </div>
      </div>
    </div>

    {# Terms & Footer #}
    <div class="footer">
      <div class="terms">
        <strong>Terms & Conditions</strong>
        <div class="small" style="margin-top:6px;">
          {% if doc.terms %}
            {{ doc.terms | nl2br }}
          {% else %}
            Please supply goods as per the specifications and delivery schedule. Bill and challan should reference this PO number. Payment will be made as per agreed terms.
          {% endif %}
        </div>
      </div>

      <div class="signature">
        <div style="margin-bottom:40px;">For <strong>{{ company.company_name or doc.company }}</strong></div>
        <div>Authorised Signatory</div>
        <div style="height:48px;"></div>
        <div class="small">Date: __________________</div>
      </div>
    </div>

    <div class="company-footer">
      {{ company.company_name }} - {{ company.company_website or '' }}
    </div>

  </div>
</body>
</html>
