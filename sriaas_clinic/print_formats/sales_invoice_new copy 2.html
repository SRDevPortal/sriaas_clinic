{# ================= Sales Invoice New (SRIAAS Clinic) ================= #}

{# --- self-contained address renderer (no external includes) --- #}
{% macro render_addr(address_name) -%}
  {% if address_name %}
    {% set a = frappe.get_doc("Address", address_name) %}
    <div class="addr">
      {% if a.address_title %}<b>{{ a.address_title }}</b>{% endif %}
      {% if a.address_type %}{% if a.address_title %} {% endif %}({{ a.address_type }}){% endif %}
      {% if a.address_title or a.address_type %}<br>{% endif %}

      {{ a.address_line1 or "" }}
      {% if a.address_line2 %}<br>{{ a.address_line2 }}{% endif %}

      {% if a.city %}<br>{{ a.city }}{% endif %}
      {% if a.state %}{% if a.city %}, {% else %}<br>{% endif %}{{ a.state }}{% endif %}
      {% if a.pincode %} {{ a.pincode }}{% endif %}

      {% if a.country %}<br>{{ a.country }}{% endif %}

      {% set gstin = a.gstin or a.gstin_uin %}
      {% if gstin %}<br><b>GSTIN:</b> {{ gstin }}{% endif %}
    </div>
  {% endif %}
{%- endmacro %}

{# ========== COMPANY + TAX INVOICE HEADER (SRIAAS) ========== #}
{% set company = frappe.get_doc("Company", doc.company) %}
{% set logo = company.company_logo %}
{% set currency = doc.currency or company.default_currency or "INR" %}

{# Prefer the address linked on the invoice; else first Company address #}
{% set comp_addr_name = doc.company_address %}
{% if not comp_addr_name %}
  {% set comp_addr_link = frappe.get_all(
      "Dynamic Link",
      filters={"parenttype":"Address","link_doctype":"Company","link_name":doc.company},
      fields=["parent"], limit=1
  ) %}
  {% set comp_addr_name = comp_addr_link[0].parent if comp_addr_link else None %}
{% endif %}
{% set comp_addr = frappe.get_doc("Address", comp_addr_name) if comp_addr_name else None %}

{# helpers #}
{% macro line(v) -%}{% if v %}{{ v }}<br>{% endif %}{%- endmacro %}
{% set reg_add_1   = (comp_addr.address_line1 if comp_addr else "") %}
{% set reg_add_2   = (comp_addr.address_line2 if comp_addr else "") %}
{% set reg_city    = (comp_addr.city if comp_addr else "") %}
{% set reg_state   = (comp_addr.state if comp_addr else "") %}
{% set reg_pin     = (comp_addr.pincode if comp_addr else "") %}
{% set gst_state_code = (comp_addr.gst_state_number if comp_addr and comp_addr.gst_state_number else "") %}
{% set company_email = company.email_id or company.company_email or "" %}
{% set company_cin   = company.cin or company.company_cin or company.custom_cin or "" %}
{% set company_gstin = doc.company_gstin or (comp_addr.gstin if comp_addr and comp_addr.gstin else "") %}

{# ==== overall GST rate (fixed at 5% if not in taxes) ==== #}
{% set overall_gst_pct = (doc.taxes[0].rate if doc.taxes and doc.taxes[0].rate is not none else 5) %}

<style>
  .si-head{border:1px solid #cfd6e4;border-collapse:collapse;width:100%;font-family:Arial,sans-serif;margin-bottom:10px}
  .si-head td{vertical-align:top;padding:10px}
  .si-head .left{width:65%}
  .si-head .right{width:35%;border-left:1px solid #cfd6e4}
  .si-logo{max-height:40px;margin-bottom:6px}
  .si-co-name{font-weight:700}
  .si-right-title{text-align:right;font-weight:700;padding-bottom:6px}
  .si-meta{width:100%;font-size:12px;border-collapse:collapse}
  .si-meta td{padding:4px 0}
  .si-meta .lbl{color:#555;width:40%;text-align:right;padding-right:10px}
  .si-meta .val{width:60%;text-align:right}
  .si-left-lines{font-size:12px;line-height:1.5}

  .si-wrap{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#111;font-size:10pt}
  .card{width:100%;border:1.25pt solid #cfd6e4;border-collapse:collapse;table-layout:fixed;font-size:10pt;margin-bottom:10pt}
  .kv td{padding:4px 6px;border-bottom:1px solid #e8ebf0;vertical-align:top}
  .kv tr:last-child td{border-bottom:0}
  .lbl{width:120px;color:#444;background:#fafbfc}
  .stack .title{font-weight:600;color:#444;background:#fafbfc;padding:6px}
  .stack .value{padding:6px}
  .tbl{width:100%;border-collapse:collapse;font-size:10pt}
  .tbl th,.tbl td{border:1px solid #e8ebf0;padding:6px;vertical-align:top}
  .right{text-align:right}
  .muted{color:#666}
  .addr{line-height:1.4}
</style>

<table class="si-head">
  <tr>
    <td class="left">
      {% if logo %}<img class="si-logo" src="{{ logo }}">{% endif %}
      <div class="si-co-name">Sr Institute of Advanced Ayurvedic Sciences Private Limited</div>
      <div class="si-left-lines">
        {{ line("Reg Add: " ~ (reg_add_1 or "")) }}
        {{ line(reg_add_2) }}
        {{ line([reg_city, reg_state, reg_pin]|reject("equalto","")|join(", ")) }}
        {{ line("CIN No: " ~ company_cin) }}
        {{ line("GSTIN/UIN: " ~ company_gstin) }}
        {% if reg_state %}{{ line("State Name: " ~ reg_state ~ (", Code: " ~ gst_state_code if gst_state_code else "")) }}{% endif %}
        {{ line("E-mail: " ~ company_email) }}
      </div>
    </td>
    <td class="right">
      <div class="si-right-title">Tax Invoice</div>
      <table class="si-meta">
        <tr><td class="lbl">Invoice No.</td><td class="val">{{ doc.name }}</td></tr>
        <tr><td class="lbl">Invoice Date</td><td class="val">{{ frappe.format(doc.posting_date, {"fieldtype":"Date"}) }}</td></tr>
        <tr><td class="lbl">Due Date</td><td class="val">{% if doc.due_date %}{{ frappe.format(doc.due_date, {"fieldtype":"Date"}) }}{% endif %}</td></tr>
      </table>
    </td>
  </tr>
</table>
{# ========== /HEADER ========== #}

{# ==== customer contact + place of supply ==== #}
{% set cust = frappe.get_doc("Customer", doc.customer) if doc.customer else None %}
{% set cust_mobile = doc.contact_mobile or (cust.mobile_no if cust and cust.mobile_no else "") %}
{% set cust_phone  = doc.contact_phone  or (cust.phone     if cust and cust.phone     else "") %}
{% set cust_email  = doc.contact_email  or (cust.email_id  if cust and cust.email_id  else "") %}

{% set pos_name = doc.place_of_supply or doc.billing_address_gst_state %}
{% set pos_code = doc.billing_address_gst_state_number %}
{% if not pos_name and doc.customer_address %}
  {% set addr_po = frappe.get_doc("Address", doc.customer_address) %}
  {% set pos_name = addr_po.state if addr_po and addr_po.state else pos_name %}
  {% set pos_code = addr_po.gst_state_number if addr_po and addr_po.gst_state_number else pos_code %}
{% endif %}

<div class="si-wrap">

  {# ===== Customer ===== #}
  <table class="card kv">
    <tr>
        <td class="lbl">Customer</td>
        <td>{{ doc.customer_name or doc.customer }}</td>
        <td class="lbl">Place of Supply</td>
        <td>
        {% if pos_name %}{{ pos_name }}{% if pos_code %} (Code: {{ pos_code }}){% endif %}{% else %}-{% endif %}
        </td>
    </tr>
    <tr>
        <td class="lbl">Billing Address</td>
        <td>{{ render_addr(doc.customer_address) }}</td>
        <td class="lbl">Shipping Address</td>
        <td>{{ render_addr(doc.shipping_address_name) }}</td>
    </tr>
    <tr>
        <td class="lbl">Mobile</td>
        <td>{{ cust_mobile or "-" }}</td>
        <td class="lbl">Phone</td>
        <td>{{ cust_phone or "-" }}</td>
    </tr>
    <tr>
        <td class="lbl">Email</td>
        <td colspan="3">{{ cust_email or "-" }}</td>
    </tr>
  </table>

  {# ===== Items ===== #}
  <table class="tbl">
    <thead>
      <tr style="background:#fafbfc;">
        <th style="width:36px;">#</th>
        <th>Item</th>
        <th style="width:90px;">HSN/SAC</th>
        <th style="width:60px;" class="right">GST %</th>
        <th style="width:80px;" class="right">Qty</th>
        <th style="width:90px;" class="right">Rate</th>
        <th style="width:100px;" class="right">Amount</th>
      </tr>
    </thead>
    <tbody>
      {% for it in (doc.items or []) %}
      {% set name = it.item_name or it.item_code %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>
          <div><b>{{ name }}</b>{% if it.uom %} <span class="muted">({{ it.uom }})</span>{% endif %}</div>
          {% if it.description %}<div class="muted">{{ it.description }}</div>{% endif %}
        </td>
        <td>{{ it.gst_hsn_code or it.sac or "" }}</td>
        <td class="right">{{ "{0:.1f}%".format((overall_gst_pct or 0)|float) }}</td>
        <td class="right">{{ frappe.utils.fmt_money(it.qty or 0, 0) }}</td>
        <td class="right">{{ frappe.utils.fmt_money(it.rate or 0, currency=currency) }}</td>
        <td class="right">{{ frappe.utils.fmt_money(it.amount or 0, currency=currency) }}</td>
      </tr>
      {% endfor %}
      {% if not doc.items or doc.items|length == 0 %}
      <tr><td colspan="7" class="muted">No items</td></tr>
      {% endif %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="6" class="right"><b>Subtotal</b></td>
        <td class="right">{{ frappe.utils.fmt_money(doc.total or 0, currency=currency) }}</td>
      </tr>
    </tfoot>
  </table>

  <!-- {# ===== Taxes & Totals ===== #} -->
  <!-- {% if doc.taxes and doc.taxes|length %}
  <table class="tbl" style="margin-top:8px;">
    <thead><tr style="background:#fafbfc;"><th>Tax / Charge</th><th style="width:120px;" class="right">Amount</th></tr></thead>
    <tbody>
      {% for tx in doc.taxes %}
      <tr><td>{{ tx.description }}</td><td class="right">{{ frappe.utils.fmt_money(tx.tax_amount or 0, currency=currency) }}</td></tr>
      {% endfor %}
      <tr><td class="right"><b>Grand Total</b></td><td class="right"><b>{{ frappe.utils.fmt_money(doc.grand_total or 0, currency=currency) }}</b></td></tr>
      {% if doc.rounded_total %}<tr><td class="right">Rounded Total</td><td class="right">{{ frappe.utils.fmt_money(doc.rounded_total, currency=currency) }}</td></tr>{% endif %}
      <tr><td class="right">Paid</td><td class="right">{{ frappe.utils.fmt_money(doc.sr_si_paid_amount or 0, currency=currency) }}</td></tr>
      <tr><td class="right"><b>Outstanding</b></td><td class="right"><b>{{ frappe.utils.fmt_money(doc.outstanding_amount or 0, currency=currency) }}</b></td></tr>
    </tbody>
  </table>
  {% else %}
  <table class="tbl" style="margin-top:8px;">
    <tr><td class="right"><b>Grand Total</b></td><td class="right" style="width:120px;"><b>{{ frappe.utils.fmt_money(doc.grand_total or 0, currency=currency) }}</b></td></tr>
    {% if doc.rounded_total %}<tr><td class="right">Rounded Total</td><td class="right">{{ frappe.utils.fmt_money(doc.rounded_total, currency=currency) }}</td></tr>{% endif %}
    <tr><td class="right">Paid</td><td class="right">{{ frappe.utils.fmt_money(doc.sr_si_paid_amount or 0, currency=currency) }}</td></tr>
    <tr><td class="right"><b>Outstanding</b></td><td class="right"><b>{{ frappe.utils.fmt_money(doc.outstanding_amount or 0, currency=currency) }}</b></td></tr>
  </table>
  {% endif %} -->

  <!-- {# Amount in words #}
  {% set amt_words = frappe.utils.money_in_words(doc.rounded_total if doc.rounded_total else doc.grand_total, currency) %}
  <div class="stack value" style="margin-top:8px;">
    <b>Amount in Words:</b> {{ amt_words }}
  </div> -->

  <style>
    .si-wrap { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size:9pt; color:#111; line-height: 1.25; }

    /* Keep headings compact but same size */
    .si-wrap h1,
    .si-wrap h2,
    .si-wrap h3,
    .si-wrap h4,
    .si-wrap h5,
    .si-wrap h6 {
      font-size: 9pt !important;
      margin: 0 0 4pt;
      font-weight: 700;
    }

      /* Tables in ERPNext print area */
    .print-format td,
    .print-format th,
    .subbar th, .subbar td,
    .sum td,
    .blk .box {
      font-size: 9pt !important;
    }
    
    /* SUBTOTAL bar */
    .subbar { width:100%; border-collapse:collapse; margin:0pt 0 8pt; }
    .subbar th, .subbar td { padding:6pt 8pt; border:1px solid transparent; }
    .subbar th { background:#dfeee0; text-transform:uppercase; letter-spacing:.5px; text-align:left; font-weight: 700; }
    .subbar td.val { width:auto !important; background:#dfeee0; text-align:right; white-space:nowrap; font-weight:700; }

    /* two-column layout */
    .twocol { width:100%; border-collapse:collapse; table-layout:fixed; font-size: 9pt; }
    .twocol td { vertical-align:top; padding:0; }
    .leftcol  { width:60%; padding-right:10pt; }
    .rightcol { width:40%; padding-left:10pt; }

    /* left blocks */
    .blk { margin-bottom:10pt; }
    .blk h4 { margin:0 0 6pt; font-size:9pt; font-weight:700; text-transform:uppercase; }
    .blk .box { border:1px solid #e5e7eb; padding:5pt 2pt; }

    /* right summary table */
    .sum { width:100%; border-collapse:collapse; }
    .sum td { padding:6pt 8pt; border-bottom:1px solid #f0f2f5; }
    .sum td.k { color:#444; }
    .sum td.v { text-align:right; white-space:nowrap; }
    .sum tr.total td { border-top:1px solid #e5e7eb; font-weight:700; }
    .sum tr.bold td { font-weight:700; }

    /* in words + signature */
    .foot-grid { width:100%; border-collapse:collapse; margin-top:10pt; }
    .foot-grid td { vertical-align:top; padding:6pt 0; }
    .sign-box { width:auto; border:1px solid #e5e7eb; border-radius:4pt; background:#fafbfc; }
    
    .scanner-box { width:80px; }

    .muted { color:#666; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>

  <div class="si-wrap">
    <!-- {# totals used in the SUBTOTAL bar #}
    {% set total_tax = doc.total_taxes_and_charges or 0 %}
    {% set grand     = (doc.rounded_total if doc.rounded_total else doc.grand_total) or 0 %} -->

    <!-- SUBTOTAL BAR -->
    <!-- <table class="subbar">
      <tr>
        <th>Subtotal</th>
        <td class="val">{{ frappe.format(grand, {'fieldtype':'Currency','options': doc.currency}) }}</td>
      </tr>
    </table> -->

    <!-- TWO COLUMNS -->
    <table class="twocol">
      <tr>
          <!-- LEFT COLUMN -->
          <td class="leftcol">
              <!-- Notes -->
              {% if doc.remarks %}
              <div class="blk">
                <h4>Notes</h4>
                <div class="box">
                  <div class="stack value">{{ doc.remarks }}</div>
                </div>
              </div>
              {% endif %}
      
              <!-- Terms & Conditions -->
              <div class="blk">
                <h4>Terms and Conditions</h4>
                <div class="box">
                  {% if doc.terms %}
                    {{ doc.terms | safe }}
                  {% else %}
                    <ol style="margin:0 0 0 14pt; padding:0;">
                      <li>All disputes are subject to Haryana jurisdiction only.</li>
                    </ol>
                  {% endif %}
                </div>
              </div>
      
              {# --- Resolve a Bank Account doc safely --- #}
              {% set ledger = frappe.db.get_value("Company", doc.company, "default_bank_account") %}
              {% set ba = None %}
              {% if ledger %}
                {% set ba_name = frappe.db.get_value("Bank Account", {"account": ledger, "company": doc.company}, "name") %}
                {% if ba_name %}
                  {% set ba = frappe.get_doc("Bank Account", ba_name) %}
                {% endif %}
              {% endif %}
              {% if not ba %}
                {% set ba_name2 = frappe.db.get_value("Bank Account", {"is_default": 1, "company": doc.company}, "name") %}
                {% if ba_name2 %}
                  {% set ba = frappe.get_doc("Bank Account", ba_name2) %}
                {% endif %}
              {% endif %}
              
              <div class="blk">
                <h4>Bank Details</h4>
                <div class="box">
                  <table style="width:100%; border-collapse:collapse;">
                    <tr><td style="padding:2pt 0 !important; width:110pt;">Name:</td>
                        <td style="padding:2pt 0 !important;"><strong>{{ doc.company }}</strong></td></tr>
                    <tr><td style="padding:2pt 0 !important;">IFSC Code:</td>
                        <td style="padding:2pt 0 !important;">{{ (ba and (ba.branch_code or ba.ifsc_code)) or "-" }}</td></tr>
                    <tr><td style="padding:2pt 0 !important;">Account No:</td>
                        <td style="padding:2pt 0 !important;">{{ (ba and ba.bank_account_no) or "-" }}</td></tr>
                    <tr><td style="padding:2pt 0 !important;">Bank:</td>
                        <td style="padding:2pt 0 !important;">{{ (ba and ba.bank) or "-" }}{% if ba and ba.branch %}, {{ ba.branch }}{% endif %}</td></tr>
                  </table>
                </div>
              </div>
      
              <!-- Payment QR -->
              <div class="blk">
                <h4>Payment QR Code</h4>
                <div class="box" style="display:flex; gap:5pt; align-items:center;">
                  <div class="scanner-box">
                      <img src="{{ frappe.utils.get_url('/files/sriaas-scanner.jpg') }}" alt="Scanner">
                    {% set qr = doc.qr_code_image or doc.qrcode_image or doc.get('einvoice_qr') %}
                    {% if qr %}
                    <img src="{{ qr }}" style="height:90pt;">
                    {% else %}
                      <div class="muted">QR not available</div>
                    {% endif %}
                  </div>
                  <div>
                    <div>UPI ID:<br><strong>sriaas@icici</strong></div>
                    <div class="muted" style="margin-top:6pt;">PhonePe • GPay • Paytm • UPI</div>
                  </div>
                </div>
              </div>
          </td>

          <!-- RIGHT COLUMN -->
          <td class="rightcol">
              <table class="sum">
                <tr>
                  <td class="k">Taxable Amount</td>
                  <td class="v">{{ doc.get_formatted('net_total') }}</td>
                </tr>
      
                {% if doc.taxes and doc.taxes|length %}
                    {% for t in doc.taxes %}
                    {% set rate = (t.rate if t.rate is not none else 0) %}
                    {% set raw  = (t.description or t.account_head or '')|trim %}
                    {% if 'CGST' in raw %}{% set taxname = 'CGST' %}
                    {% elif 'SGST' in raw %}{% set taxname = 'SGST' %}
                    {% elif 'IGST' in raw %}{% set taxname = 'IGST' %}
                    {% elif 'CESS' in raw %}{% set taxname = 'CESS' %}
                    {% else %}{% set taxname = raw
                                  | replace(' @0.0%','') | replace('@0.0%','')
                                  | replace(' @ 0.0%','') | replace(' @0%','') | replace('@0%','') %}{% endif %}
                    <tr>
                      <td class="k">
                        {{ taxname }}{% if rate %} @{{ frappe.format(rate, {'fieldtype':'Percent'}) }}{% endif %}
                      </td>
                      <td class="v">
                        {{ frappe.format(t.tax_amount or 0, {'fieldtype':'Currency','options': doc.currency}) }}
                      </td>
                    </tr>
                    {% endfor %}
                  {% endif %}
      
                <tr class="total">
                  <td class="k">Total Amount</td>
                  <td class="v">{{ (doc.rounded_total and doc.get_formatted('rounded_total')) or doc.get_formatted('grand_total') }}</td>
                </tr> 

                {# Received = allocated advances on this invoice #}
                {% set received = (doc.total_advance or 0) %}
                {# Fallback if needed: recompute from totals #}
                {% if not received and (doc.outstanding_amount is not none) %}
                  {% set received = ((grand or 0) - (doc.outstanding_amount or 0) - (doc.write_off_amount or 0)) %}
                {% endif %}
                
                {% if (received or 0) > 0 %}
                <tr>
                  <td class="k">Received Amount</td>
                  <td class="v">- {{ frappe.format(received, {'fieldtype':'Currency','options': doc.currency}) }}</td>
                </tr>
                {% endif %}
      
                <tr class="bold">
                  <td class="k">Balance</td>
                  <td class="v">{{ doc.get_formatted('outstanding_amount') }}</td>
                </tr>
              </table>
      
              <div style="margin-top:12pt; text-align:right;">
                <div class="muted">Total Amount (in words)</div>
                <div><strong>{{ (doc.in_words or doc.base_in_words) | trim }}</strong></div>
              </div>
      
              <div style="margin-top:12pt; gap:12pt; align-items:flex-end; justify-content:flex-end;">
                <div class="sign-box">
                    <img src="{{ frappe.utils.get_url('/files/sriaas-sign-and-stam.jpg') }}"
                        alt="Authorised Signatory">
                </div>
                <div style="text-align:right; margin-top: 5pt">
                  <div class="muted">Authorised Signature for</div>
                  <div><strong>{{ doc.company }}</strong></div>
                </div>
              </div>
          </td>
      </tr>
    </table>
  </div>
</div>
